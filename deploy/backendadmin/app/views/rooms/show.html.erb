<div class="min-h-screen bg-gray-50">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Room: <%= @room['name'] %></h1>
          <p class="text-gray-600 mt-2">SID: <%= @room['sid'] %></p>
        </div>
        <div class="flex space-x-2">
          <button onclick="joinRoom('<%= @room['name'] %>')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">
            Join Room
          </button>
          <%= link_to "Delete Room", room_path(@room['name']), method: :delete, data: { confirm: "Are you sure?" }, class: "bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition" %>
        </div>
      </div>
    </div>

    <% if @error %>
      <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
        <%= @error %>
      </div>
    <% end %>

    <!-- Room Info Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-3">Room Settings</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Max Participants:</span>
            <span class="font-medium"><%= @room['max_participants'] %></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Empty Timeout:</span>
            <span class="font-medium"><%= @room['empty_timeout'] %>s</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Departure Timeout:</span>
            <span class="font-medium"><%= @room['departure_timeout'] %>s</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Created:</span>
            <span class="font-medium"><%= Time.at(@room['creation_time'].to_i).strftime("%b %d, %H:%M") rescue "N/A" %></span>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-3">Status</h3>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-gray-600">Participants:</span>
            <span class="px-3 py-1 text-sm font-semibold rounded-full <%= @room['num_participants'].to_i > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' %>">
              <%= @room['num_participants'] || 0 %> / <%= @room['max_participants'] %>
            </span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-gray-600">Publishers:</span>
            <span class="font-medium"><%= @room['num_publishers'] || 0 %></span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-gray-600">Recording:</span>
            <span class="px-2 py-1 text-xs font-semibold rounded-full <%= @room['active_recording'] ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800' %>">
              <%= @room['active_recording'] ? 'Active' : 'Inactive' %>
            </span>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-3">Metadata</h3>
        <% if @room['metadata'] && !@room['metadata'].empty? %>
          <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto"><%= @room['metadata'] %></pre>
          <button onclick="editMetadata()" class="mt-3 text-blue-600 hover:text-blue-800 text-sm">Edit Metadata</button>
        <% else %>
          <p class="text-gray-500 text-sm">No metadata set</p>
          <button onclick="editMetadata()" class="mt-3 text-blue-600 hover:text-blue-800 text-sm">Add Metadata</button>
        <% end %>
      </div>
    </div>

    <!-- Participants Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold">Participants (<%= @participants.size %>)</h2>
      </div>
      
      <% if @participants && @participants.any? %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participant</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tracks</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Connection</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permissions</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @participants.each do |participant| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4">
                    <div>
                      <div class="text-sm font-medium text-gray-900"><%= participant['name'] || participant['identity'] %></div>
                      <div class="text-xs text-gray-500">ID: <%= participant['identity'] %></div>
                      <div class="text-xs text-gray-400">SID: <%= participant['sid'] %></div>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="space-y-1">
                      <% (participant['tracks'] || []).each do |track| %>
                        <div class="flex items-center space-x-2">
                          <span class="text-xs px-2 py-1 rounded <%= track['type'] == 'VIDEO' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800' %>">
                            <%= track['type'] %>
                          </span>
                          <% if track['muted'] %>
                            <span class="text-xs text-red-600">Muted</span>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-xs">
                      <div>State: <span class="font-medium"><%= participant['state'] %></span></div>
                      <div>Joined: <%= Time.at(participant['joined_at'].to_i).strftime("%H:%M:%S") rescue "N/A" %></div>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-xs space-y-1">
                      <div>
                        <span class="<%= participant['permission']['can_publish'] ? 'text-green-600' : 'text-red-600' %>">
                          <%= participant['permission']['can_publish'] ? '✓' : '✗' %> Publish
                        </span>
                      </div>
                      <div>
                        <span class="<%= participant['permission']['can_subscribe'] ? 'text-green-600' : 'text-red-600' %>">
                          <%= participant['permission']['can_subscribe'] ? '✓' : '✗' %> Subscribe
                        </span>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm">
                    <div class="flex flex-col space-y-1">
                      <button onclick="muteParticipant('<%= participant['identity'] %>', '<%= participant['sid'] %>')" class="text-yellow-600 hover:text-yellow-900 text-left">
                        Mute/Unmute
                      </button>
                      <%= link_to "Remove", remove_room_participant_path(@room['name'], participant['identity']), method: :delete, data: { confirm: "Remove this participant?" }, class: "text-red-600 hover:text-red-900" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-8 text-gray-500">
          No participants in this room
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function joinRoom(roomName) {
    const identity = prompt("Enter your name to join the room:", "Admin");
    
    if (identity) {
      fetch('/rooms/generate_token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
          room_name: roomName,
          identity: identity,
          name: identity,
          can_publish: true,
          can_subscribe: true
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.join_url) {
          window.open(data.join_url, '_blank');
        } else {
          alert(`Error: ${data.error}`);
        }
      });
    }
  }
  
  function editMetadata() {
    const currentMetadata = <%= raw(@room['metadata'] || '{}').to_json %>;
    const newMetadata = prompt("Enter new metadata (JSON format):", JSON.stringify(currentMetadata));
    
    if (newMetadata) {
      fetch('<%= update_metadata_room_path(@room['name']) %>', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ metadata: newMetadata })
      })
      .then(() => window.location.reload());
    }
  }
  
  function muteParticipant(identity, sid) {
    // This would need more implementation to select specific tracks
    alert(`Mute functionality for ${identity} would be implemented here`);
  }
</script>